<app-navbar></app-navbar>

<div class="planifications-layout" (keydown)="onKeyDown($event)">
  <div class="planifications-container">
    
    <!-- Professional Header Section -->
    <div class="planifications-header animate-fadeIn">
      <div class="header-content">
        <div class="header-left">
          <div class="header-icon">
            <i class="bi bi-calendar-week"></i>
          </div>
          <div class="header-text">
            <h1>Mes Planifications de Soutenance</h1>
            <p>Gérez vos planifications et organisez les créneaux de soutenance pour vos étudiants</p>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn btn-outline-secondary" (click)="refreshData()">
            <i class="bi bi-arrow-clockwise"></i>
            <span>Actualiser</span>
          </button>
          <button class="btn btn-primary" (click)="downloadPlanificationsExcel()">
            <i class="bi bi-file-earmark-excel"></i>
            <span>Exporter Excel</span>
          </button>
          <a routerLink="/encadrant/dashboard" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i>
            <span>Retour</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Statistics Dashboard -->
    <div class="stats-section animate-slideInLeft">
      <div class="stats-grid">
        <div class="stat-card stat-primary">
          <div class="stat-icon">
            <i class="bi bi-calendar-event"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ stats.total }}</div>
            <div class="stat-label">Total Planifications</div>
            <div class="stat-trend positive">
              <i class="bi bi-arrow-up"></i>
              <span>Toutes vos planifications</span>
            </div>
          </div>
        </div>

        <div class="stat-card stat-success">
          <div class="stat-icon">
            <i class="bi bi-calendar-check"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ stats.upcoming }}</div>
            <div class="stat-label">Prochaines</div>
            <div class="stat-trend positive">
              <i class="bi bi-arrow-up"></i>
              <span>Soutenances à venir</span>
            </div>
          </div>
        </div>

        <div class="stat-card stat-secondary">
          <div class="stat-icon">
            <i class="bi bi-calendar-x"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ stats.past }}</div>
            <div class="stat-label">Terminées</div>
            <div class="stat-trend neutral">
              <i class="bi bi-check-circle"></i>
              <span>Soutenances passées</span>
            </div>
          </div>
        </div>

        <div class="stat-card stat-info">
          <div class="stat-icon">
            <i class="bi bi-clock"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ stats.totalSlots }}</div>
            <div class="stat-label">Créneaux Total</div>
            <div class="stat-trend positive">
              <i class="bi bi-plus-circle"></i>
              <span>Créneaux programmés</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content animate-slideInRight">
      
      <!-- Planifications List View -->
      <div *ngIf="!selectedPlanification" class="planifications-view">
        <div class="view-header">
          <div class="view-title">
            <h2>
              <i class="bi bi-list-check"></i>
              Vos Planifications
            </h2>
            <p>Cliquez sur une planification pour gérer ses créneaux</p>
          </div>
          <div class="view-actions">
            <div class="search-filter">
              <i class="bi bi-search"></i>
              <input type="text" placeholder="Rechercher une planification..." class="search-input">
            </div>
          </div>
        </div>

        <!-- Professional Data Table -->
        <div class="planifications-table">
          <div class="table-container">
            <div class="table-header">
              <div class="header-info">
                <h3>Liste des Planifications</h3>
                <span class="count-badge">{{ planifications.length }} planification(s)</span>
              </div>
            </div>

            <div class="table-body" *ngIf="!loading">
              <div *ngIf="planifications.length === 0" class="empty-state">
                <div class="empty-icon">
                  <i class="bi bi-calendar-x"></i>
                </div>
                <h4>Aucune planification</h4>
                <p>Vous n'avez pas encore de planifications assignées</p>
              </div>

              <div *ngIf="planifications.length > 0" class="planifications-grid">
                <div *ngFor="let planification of planifications; let i = index" 
                     class="planification-card"
                     [style.animation-delay]="i * 100 + 'ms'"
                     (click)="viewPlanificationDetails(planification)">
                  
                  <div class="card-header">
                    <div class="date-badge" [ngClass]="getStatusBadgeClass(planification)">
                      <div class="date-main">
                        <span class="day">{{ planification.dateSoutenance | date:'dd' }}</span>
                        <span class="month">{{ planification.dateSoutenance | date:'MMM' }}</span>
                      </div>
                      <div class="date-year">{{ planification.dateSoutenance | date:'yyyy' }}</div>
                    </div>
                    
                    <div class="status-indicator">
                      <span class="status-badge" [ngClass]="getStatusBadgeClass(planification)">
                        <i class="bi bi-circle-fill"></i>
                        {{ getStatusText(planification) }}
                      </span>
                    </div>
                  </div>

                  <div class="card-body">
                    <div class="planification-info">
                      <div class="info-row">
                        <div class="info-item">
                          <div class="info-icon">
                            <i class="bi bi-person-badge"></i>
                          </div>
                          <div class="info-content">
                            <span class="info-label">Encadrant</span>
                            <span class="info-value">{{ getEncadrantName(planification.encadrant) }}</span>
                          </div>
                        </div>
                      </div>

                      <div class="info-row">
                        <div class="info-item">
                          <div class="info-icon">
                            <i class="bi bi-building"></i>
                          </div>
                          <div class="info-content">
                            <span class="info-label">Département</span>
                            <span class="info-value">{{ planification.departement.nom }}</span>
                          </div>
                        </div>
                      </div>

                      <div class="info-row">
                        <div class="info-item">
                          <div class="info-icon">
                            <i class="bi bi-people"></i>
                          </div>
                          <div class="info-content">
                            <span class="info-label">Classe</span>
                            <span class="info-value">{{ planification.classeGroupe.nom }}</span>
                          </div>
                        </div>

                        <div class="info-item">
                          <div class="info-icon">
                            <i class="bi bi-calendar-range"></i>
                          </div>
                          <div class="info-content">
                            <span class="info-label">Année</span>
                            <span class="info-value">{{ planification.anneeScolaire.libelle }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="card-footer">
                    <div class="action-buttons">
                      <button class="btn btn-primary btn-sm" 
                              (click)="viewPlanificationDetails(planification); $event.stopPropagation()">
                        <i class="bi bi-eye"></i>
                        <span>Voir créneaux</span>
                      </button>
                      <button class="btn btn-outline-success btn-sm" 
                              (click)="openDetailModal(planification); $event.stopPropagation()">
                        <i class="bi bi-plus-circle"></i>
                        <span>Ajouter créneau</span>
                      </button>
                      <button class="btn btn-outline-secondary btn-sm" 
                              (click)="downloadSelectedPlanifExcel(); $event.stopPropagation()">
                        <i class="bi bi-file-earmark-pdf"></i>
                        <span>Export</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div *ngIf="loading" class="loading-state">
              <div class="loading-spinner"></div>
              <p>Chargement de vos planifications...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Planification Details View -->
      <div *ngIf="selectedPlanification" class="details-view">
        <!-- Details Header -->
        <div class="details-header">
          <div class="header-content">
            <div class="header-left">
              <div class="back-button" (click)="backToPlanifications()">
                <i class="bi bi-arrow-left"></i>
              </div>
              <div class="header-text">
                <h2>Créneaux de Soutenance</h2>
                <p>{{ formatDate(selectedPlanification.dateSoutenance) }} - {{ selectedPlanification.departement.nom }}</p>
              </div>
            </div>
            <div class="header-actions">
              <button class="btn btn-success" (click)="openDetailModal(selectedPlanification)">
                <i class="bi bi-plus-circle"></i>
                <span>Nouveau créneau</span>
              </button>
              <button class="btn btn-outline-primary" (click)="downloadSelectedPlanifExcel()">
                <i class="bi bi-file-earmark-excel"></i>
                <span>Exporter</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Slots Statistics -->
        <div class="slots-stats">
          <div class="stats-grid">
            <div class="mini-stat">
              <div class="mini-stat-icon">
                <i class="bi bi-clock"></i>
              </div>
              <div class="mini-stat-content">
                <div class="mini-stat-value">{{ planificationDetails.length }}</div>
                <div class="mini-stat-label">Créneaux</div>
              </div>
            </div>

            <div class="mini-stat">
              <div class="mini-stat-icon success">
                <i class="bi bi-person-check"></i>
              </div>
              <div class="mini-stat-content">
                <div class="mini-stat-value">{{ planificationDetails.filter(d => d.etudiant?.id).length }}</div>
                <div class="mini-stat-label">Assignés</div>
              </div>
            </div>

            <div class="mini-stat">
              <div class="mini-stat-icon warning">
                <i class="bi bi-circle"></i>
              </div>
              <div class="mini-stat-content">
                <div class="mini-stat-value">{{ planificationDetails.filter(d => !d.etudiant?.id).length }}</div>
                <div class="mini-stat-label">Libres</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Professional Details Table -->
        <div class="details-table">
          <div class="table-container">
            <div class="table-header">
              <div class="header-info">
                <h3>Créneaux Programmés</h3>
                <span class="count-badge">{{ planificationDetails.length }} créneau(x)</span>
              </div>
              <div class="table-actions">
                <button class="btn btn-outline-primary btn-sm" (click)="refreshData()">
                  <i class="bi bi-arrow-clockwise"></i>
                  Actualiser
                </button>
              </div>
            </div>

            <div class="table-body" *ngIf="!loadingDetails">
              <div *ngIf="planificationDetails.length === 0" class="empty-state">
                <div class="empty-icon">
                  <i class="bi bi-clock"></i>
                </div>
                <h4>Aucun créneau</h4>
                <p>Cette planification ne contient pas encore de créneaux</p>
                <button class="btn btn-primary" (click)="openDetailModal(selectedPlanification)">
                  <i class="bi bi-plus-circle"></i>
                  Ajouter le premier créneau
                </button>
              </div>

              <div *ngIf="planificationDetails.length > 0" class="slots-timeline">
                <div *ngFor="let detail of planificationDetails; let i = index" 
                     class="slot-item"
                     [class.slot-assigned]="detail.etudiant?.id"
                     [class.slot-available]="!detail.etudiant?.id"
                     [style.animation-delay]="i * 80 + 'ms'">
                  
                  <div class="slot-timeline">
                    <div class="timeline-dot"></div>
                    <div class="timeline-line" *ngIf="i < planificationDetails.length - 1"></div>
                  </div>

                  <div class="slot-content">
                    <div class="slot-header">
                      <div class="time-info">
                        <div class="time-badge">
                          <i class="bi bi-clock"></i>
                          <span>{{ formatTime(detail.heureDebut) }} - {{ formatTime(detail.heureFin) }}</span>
                        </div>
                        <div class="duration-badge">
                          {{ getDuration(detail.heureDebut, detail.heureFin) }}
                        </div>
                      </div>
                      
                      <div class="slot-status">
                        <span class="status-badge" 
                              [class.badge-success]="detail.etudiant?.id"
                              [class.badge-warning]="!detail.etudiant?.id">
                          <i class="bi" 
                             [class.bi-person-check]="detail.etudiant?.id"
                             [class.bi-circle]="!detail.etudiant?.id"></i>
                          {{ detail.etudiant?.id ? 'Assigné' : 'Libre' }}
                        </span>
                      </div>
                    </div>

                    <div class="slot-details">
                      <h4>{{ detail.sujet }}</h4>
                      <div class="student-info" *ngIf="detail.etudiant?.id">
                        <div class="student-avatar">
                          {{ (detail.etudiant?.prenom || 'E').charAt(0) }}{{ (detail.etudiant?.nom || 'T').charAt(0) }}
                        </div>
                        <div class="student-details">
                          <span class="student-name">{{ detail.etudiant?.prenom }} {{ detail.etudiant?.nom }}</span>
                          <span class="student-id">ID: {{ detail.etudiant?.id }}</span>
                        </div>
                      </div>
                      <div class="available-info" *ngIf="!detail.etudiant?.id">
                        <i class="bi bi-circle"></i>
                        <span>Créneau disponible pour assignation</span>
                      </div>
                    </div>

                    <div class="slot-actions">
                      <button class="btn btn-outline-primary btn-sm" 
                              (click)="editDetail(detail)"
                              title="Modifier ce créneau">
                        <i class="bi bi-pencil"></i>
                        <span>Modifier</span>
                      </button>
                      <button class="btn btn-outline-danger btn-sm" 
                              (click)="deleteDetail(detail)"
                              title="Supprimer ce créneau">
                        <i class="bi bi-trash"></i>
                        <span>Supprimer</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div *ngIf="loadingDetails" class="loading-state">
              <div class="loading-spinner"></div>
              <p>Chargement des créneaux...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Professional Modal for Adding/Editing Slots -->
<div *ngIf="showDetailModal" class="modal-overlay animate-fadeIn" (click)="closeDetailModal()">
  <div class="modal-card animate-scaleIn" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">
        <div class="title-icon">
          <i class="bi bi-clock"></i>
        </div>
        <div class="title-text">
          <h3>{{ newDetail.id ? 'Modifier le créneau' : 'Nouveau créneau' }}</h3>
          <p>{{ formatDate(selectedPlanification?.dateSoutenance || '') }}</p>
        </div>
      </div>
      <button class="modal-close" (click)="closeDetailModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <form (ngSubmit)="addDetailToPlanification()" #detailForm="ngForm" class="modal-form">
        <div class="form-section">
          <div class="form-group">
            <label class="form-label">
              <i class="bi bi-journal-text"></i>
              <span>Sujet de soutenance *</span>
            </label>
            <input
              type="text"
              class="form-control modern-input"
              [(ngModel)]="newDetail.sujet"
              name="sujet"
              required
              placeholder="Ex: Développement d'une application web">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">
                <i class="bi bi-clock"></i>
                <span>Heure de début *</span>
              </label>
              <input
                type="time"
                class="form-control modern-input"
                [(ngModel)]="newDetail.heureDebut"
                name="heureDebut"
                required>
            </div>

            <div class="form-group">
              <label class="form-label">
                <i class="bi bi-clock-fill"></i>
                <span>Heure de fin *</span>
              </label>
              <input
                type="time"
                class="form-control modern-input"
                [(ngModel)]="newDetail.heureFin"
                name="heureFin"
                required>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="bi bi-person"></i>
              <span>Étudiant (optionnel)</span>
            </label>
            <select
              class="form-control modern-input"
              [(ngModel)]="newDetail.etudiant.id"
              name="etudiantId">
              <option value="0">Créneau libre (à assigner plus tard)</option>
              <option *ngFor="let student of students" [value]="student.id">
                {{ student.prenom }} {{ student.nom }}
              </option>
            </select>
            <small class="form-help">
              <i class="bi bi-info-circle"></i>
              Vous pouvez laisser le créneau libre et assigner un étudiant plus tard
            </small>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-outline-secondary" (click)="closeDetailModal()">
            <i class="bi bi-x-circle"></i>
            <span>Annuler</span>
          </button>
          <button type="submit" 
                  class="btn btn-primary" 
                  [disabled]="!detailForm.valid">
            <i class="bi bi-check-lg"></i>
            <span>{{ newDetail.id ? 'Modifier' : 'Créer' }} le créneau</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Floating Action Button -->
<div class="fab-container">
  <button class="fab-primary" 
          (click)="openDetailModal(selectedPlanification)"
          *ngIf="selectedPlanification"
          title="Ajouter un créneau">
    <i class="bi bi-plus-lg"></i>
  </button>
</div>